name: CI - Build Linux & Windows

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    env:
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: 0

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      # --- LINUX SETUP ---
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          # Add Wayland dev (provides wayland-client.pc) plus some common Qt/native dev packages
          sudo apt-get install -y libwayland-dev libxkbcommon-dev libx11-dev libxcb1-dev \
            qt6-base-dev qt6-declarative-dev cmake ninja-build pkg-config
          echo "QT_QMAKE_EXECUTABLE=$(which qmake6 || which qmake)" >> $GITHUB_ENV

      # --- WINDOWS SETUP ---
      - name: Install Qt (Windows)
        if: matrix.os == 'windows-latest'
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.3'
          arch: 'win64_msvc2019_64'
          # This action automatically adds Qt bin to PATH and sets env vars

      - name: Setup MSVC (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      # --- BUILD ---
      - name: Build (release)
        run: cargo build --release

      # --- PACKAGE LINUX ---
      - name: Package (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get install -y p7zip-full upx-ucl pixz
          
          mkdir -p artifact
          cp target/release/VFileX artifact/
          cp -r qml media resources.qrc artifact/ || true

          # Safe to UPX binary on Linux
          upx --best --lzma artifact/VFileX || echo "UPX skipped"

          cd artifact && tar -cf ../payload.tar * && cd ..
          pixz -9 payload.tar payload.tar.xz

          printf '%s\n' '#!/bin/bash' '# VFileX Self-Extracting Launcher' 'TMPDIR=$(mktemp -d /tmp/VFileX.XXXXXX)' 'ARCHIVE_START=$(awk '"'"'/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }'"'"' "$0")' 'tail -n+$ARCHIVE_START "$0" | xz -d | tar -xf - -C "$TMPDIR"' 'cd "$TMPDIR"' './VFileX "$@"' 'EXIT_CODE=$?' 'cd /' 'rm -rf "$TMPDIR"' 'exit $EXIT_CODE' '__ARCHIVE_BELOW__' > VFileX-launcher.sh
          cat payload.tar.xz >> VFileX-launcher.sh
          chmod +x VFileX-launcher.sh
          mv VFileX-launcher.sh VFileX-linux

      # --- PACKAGE WINDOWS ---
      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # start fresh each run
          $artifactDir = "artifact"
          if (Test-Path $artifactDir) { Remove-Item -Recurse -Force $artifactDir }
          New-Item -ItemType Directory -Force -Path $artifactDir | Out-Null

          # copy executable and supporting files
          $exeSource = "target\release\VFileX.exe"
          if (-not (Test-Path $exeSource)) {
            throw "Executable not found at $exeSource"
          }
          Copy-Item $exeSource -Destination $artifactDir
          if (Test-Path "qml") { Copy-Item "qml" -Destination $artifactDir -Recurse }
          if (Test-Path "media") { Copy-Item "media" -Destination $artifactDir -Recurse }

          # deploy Qt runtime files
          Write-Host "Running windeployqt..."
          windeployqt --dir $artifactDir --qmldir qml --compiler-runtime --no-translations --no-opengl-sw --release "$artifactDir\VFileX.exe"

          # remove unneeded cruft
          Remove-Item "$artifactDir\opengl32sw.dll" -ErrorAction Ignore
          Get-ChildItem $artifactDir -Filter *.pdb -Recurse | Remove-Item -Force -ErrorAction Ignore

          # sanity checks
          if (-not (Test-Path "$artifactDir\Qt6Core.dll")) { throw "Qt6Core.dll missing!" }
          if (-not (Test-Path "$artifactDir\platforms\qwindows.dll")) { throw "qwindows.dll missing!" }
          $runtimes = Get-ChildItem $artifactDir -Filter "*runtime*.dll"
          if ($runtimes.Count -eq 0) { Write-Host "WARNING: No compiler runtime DLLs found. The app might require VC++ Redist on user machine." }

          # package as a simple zip; keep CI clean and avoid extra dependencies
          Write-Host "Packaging ZIP archive"
          Compress-Archive -Path "$artifactDir\*" -DestinationPath "VFileX-windows.zip" -Force

      - name: Clean build artifacts
        if: matrix.os == 'windows-latest'
        run: |
          # remove build state so matrix runs stay lean
          cargo clean
      - name: Remove MSI installers & runner temp (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host "Removing MSI files and cleaning runner temp locations"
          $paths = @($env:TEMP, $env:RUNNER_TEMP, $env:RUNNER_TOOL_CACHE, "$env:USERPROFILE\Downloads", "$PWD")
          foreach ($p in $paths) {
            if (Test-Path $p) {
              Get-ChildItem -Path $p -Filter *.msi -Recurse -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
            }
          }
          # Also remove any MSI files left in the repository/workspace
          Get-ChildItem -Path . -Include *.msi -Recurse -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
          Write-Host "MSI cleanup done."
      # --- UPLOADS ---
      - name: Upload artifact (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: VFileX-linux
          path: VFileX-linux

      - name: Upload artifact (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: VFileX-windows
          path: VFileX-windows.zip
