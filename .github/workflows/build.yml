name: CI - Build Linux & Windows

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    env:
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: 0

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      # --- LINUX SETUP ---
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          # Add Wayland dev (provides wayland-client.pc) plus some common Qt/native dev packages
          sudo apt-get install -y libwayland-dev libxkbcommon-dev libx11-dev libxcb1-dev \
            qt6-base-dev qt6-declarative-dev cmake ninja-build pkg-config
          echo "QT_QMAKE_EXECUTABLE=$(which qmake6 || which qmake)" >> $GITHUB_ENV

      # --- WINDOWS SETUP ---
      - name: Install Qt (Windows)
        if: matrix.os == 'windows-latest'
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.3'
          arch: 'win64_msvc2019_64'
          # This action automatically adds Qt bin to PATH and sets env vars

      - name: Setup MSVC (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      # --- BUILD ---
      - name: Build (release)
        run: cargo build --release

      # --- PACKAGE LINUX ---
      - name: Package (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get install -y p7zip-full upx-ucl pixz
          
          mkdir -p artifact
          cp target/release/VFileX artifact/
          cp -r qml media resources.qrc artifact/ || true

          # Safe to UPX binary on Linux
          upx --best --lzma artifact/VFileX || echo "UPX skipped"

          cd artifact && tar -cf ../payload.tar * && cd ..
          pixz -9 payload.tar payload.tar.xz

          printf '%s\n' '#!/bin/bash' '# VFileX Self-Extracting Launcher' 'TMPDIR=$(mktemp -d /tmp/VFileX.XXXXXX)' 'ARCHIVE_START=$(awk '"'"'/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }'"'"' "$0")' 'tail -n+$ARCHIVE_START "$0" | xz -d | tar -xf - -C "$TMPDIR"' 'cd "$TMPDIR"' './VFileX "$@"' 'EXIT_CODE=$?' 'cd /' 'rm -rf "$TMPDIR"' 'exit $EXIT_CODE' '__ARCHIVE_BELOW__' > VFileX-launcher.sh
          cat payload.tar.xz >> VFileX-launcher.sh
          chmod +x VFileX-launcher.sh
          mv VFileX-launcher.sh VFileX-linux

      # --- PACKAGE WINDOWS (FIXED) ---
      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # 1. Install 7-Zip (No UPX)
          choco install 7zip -y
          
          # 2. Prepare Directory
          $artifactDir = "artifact"
          New-Item -ItemType Directory -Force -Path $artifactDir | Out-Null
          
          $exeSource = "target\release\VFileX.exe"
          if (-not (Test-Path $exeSource)) { throw "Executable not found at $exeSource" }
          Copy-Item $exeSource -Destination $artifactDir
          
          # 3. Copy QML/Resources
          if (Test-Path "qml") { Copy-Item "qml" -Destination $artifactDir -Recurse }
          if (Test-Path "media") { Copy-Item "media" -Destination $artifactDir -Recurse }

          # 4. Run Windeployqt (SAFE MODE)
          # REMOVED: --no-compiler-runtime (We WANT the runtime now)
          # ADDED: --compiler-runtime (Bundles vcruntime140.dll, etc.)
          Write-Host "Running windeployqt..."
          windeployqt --dir $artifactDir --qmldir qml --compiler-runtime --no-translations --no-opengl-sw --release "$artifactDir\VFileX.exe"

          # 5. Clean up bloat (but keep the important stuff)
          if (Test-Path "$artifactDir\opengl32sw.dll") { Remove-Item "$artifactDir\opengl32sw.dll" }
          Get-ChildItem $artifactDir -Filter *.pdb -Recurse | Remove-Item

          # 6. Verify Critical DLLs
          if (-not (Test-Path "$artifactDir\Qt6Core.dll")) { throw "Qt6Core.dll missing!" }
          if (-not (Test-Path "$artifactDir\platforms\qwindows.dll")) { throw "qwindows.dll missing!" }
          
          # Verify Runtime (prevent 0xc0000142 on fresh Windows installs)
          # Note: Names vary slightly by version, but usually vcruntime140.dll is the key one.
          $runtimes = Get-ChildItem $artifactDir -Filter "*runtime*.dll"
          if ($runtimes.Count -eq 0) { Write-Host "WARNING: No compiler runtime DLLs found. The app might require VC++ Redist on user machine." }

          # 7. Create SFX with 7-Zip (NO UPX COMPRESSION STEPS)
          Write-Host "Creating SFX..."
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          $sfxModule = "C:\Program Files\7-Zip\7z.sfx"
          
          # High compression 7z archive
          & $7zPath a -t7z -m0=lzma2 -mx=9 -mfb=273 -ms=on "payload.7z" ".\$artifactDir\*"

          $configLines = @(
            ';!@Install@!UTF-8!',
            'Title="VFileX"',
            'GUIMode="2"',            
            'OverwriteMode="0"',
            'RunProgram="VFileX.exe"',
            ';!@InstallEnd@!'
          )
          $configLines -join "`r`n" | Set-Content -Path config.txt -NoNewline

          cmd /c "copy /b `"$sfxModule`" + config.txt + payload.7z VFileX-portable.exe"
      # --- UPLOADS ---
      - name: Upload artifact (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: VFileX-linux
          path: VFileX-linux

      - name: Upload artifact (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: VFileX-windows-portable
          path: VFileX-portable.exe
